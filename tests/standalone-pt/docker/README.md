# Standalone performance test - Docker

In order to run standalone performance tests, you need to have built or re-build various docker
images which are used by the `docker-compose.yml` script contained in this directory.

## Prerequisites software
* Docker version 19.03.6 or later
* docker compose version v2.12.2 or later

##  Prerequisites images
Joynr has a variety of docker images. The standalone test needs `joynr-complete-with-joynr` image.
Because joynr, its libraries/runtimes along with joynr dependencies are already installed in it.
However, the images `joynr-complete-with-joynr` depends on another image, namely `joynr-base`.

The easiest way to build all necessary images is to run the `joynr-docker` script with the `build`
parameter: `$JOYNR_HOME/docker/joynr-docker build`. Afterwards, the `joynr-complete-with-joynr`
can be built with `$JOYNR_HOME/docker/joynr-complete-with-joynr/build_image.sh`.
With all those images, the images for the standalone test can be built.

## Building standalone test images
Run the `build_all.sh` script to build the necessary images for standalone test which is located in
the current working directory. This will build the `joynr-gcd-db` and `joynr-gcd` images. Please see the `JOYNR_HOME/docker/build_backend.sh` for more info. The `build_all.sh` script will also build
these images : `joynr-hivemq` , `joynr-jee-provider`,
`joynr-consumer`. All those images should be listed when running `docker images`.

## Parameters
### Applications
The settings for the C++ applications can be seen in `joynr-consumer/start-me-up.sh`. If you want to
change them, do so in the `docker-compose.yml` for the `consumer` service.

Some settings originally configurable inside the `docker-compose.yaml` are parameterized and can be
conveniently configured inside the `compose.conf` which is automatically found and used by the
docker compose via the `.env` symlink inside this directory.
### Traffic Shaping
You can configure the behaviour of the traffic shaping via the `compose.conf` file.
`docker-tc` supports multiple different ways traffic shaping. More information about the possibilities
can be found at: https://github.com/lukaszlach/docker-tc/blob/master/docker-compose.yml 

## Running test scenario
Run the `./run_pt.sh` script to start all services. This will instantiate a number of `consumer` services
as defined by the `--scale consumer=N` parameter passed to the `docker compose` command in the script.
Container names will be auto-generated by docker compose using the pattern `docker_SERVICENAME_NUM`

The script runs forever, until the user stops it with Ctrl-C. The Docker containers will be stopped and
cleaned up, and the `results` folder will be created in the current working directory and is
populated with the statistics collected from the containers.

## Plotting test results
If it is desired to visualize the test results you can execute the `./plot_results.sh` script which will
take the `resultsOfAllContainers.csv` as input and plot the to a `results.png` file. In order to do the
plotting the tool `gnuplot` is required and must be installed manually e.g. by utilizing your systems
package manager.
